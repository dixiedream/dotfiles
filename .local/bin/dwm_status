#!/bin/bash
# Network speed stuff stolen from http://linuxclues.blogspot.sg/2009/11/shell-script-show-network-speed.html

print_mem(){
    free -m | awk 'NR==2{printf "%s%sM\n", "^c#EBCB8B^", $3 }'
}

print_cpu(){
    color="^c#bf616a^"
    cpu="$(top -b -n1 | grep "Cpu(s)" | awk '{print $2 + $4}' | sed "s/\..*//")"
    printf "%sCPU %s%%" $color $cpu
}

print_network(){
    downColor="^c#BF616A^"
    upColor="^c#88c0d0^"
	logfile=/dev/shm/netlog
	[ -f "$logfile" ] || echo "0 0" > "$logfile"
	read -r rxprev txprev < "$logfile"
	rxcurrent="$(($(paste -d '+' /sys/class/net/[ew]*/statistics/rx_bytes)))"
	txcurrent="$(($(paste -d '+' /sys/class/net/[ew]*/statistics/tx_bytes)))"
	printf "%sD %s %sU %s" $downColor $(bc <<< "scale=2; ($rxcurrent-$rxprev) / 10^6") $upColor $(bc <<< "scale=2; ($txcurrent-$txprev) / 10^6")
	echo "$rxcurrent $txcurrent" > "$logfile"
}

print_temp(){
    color="^c#a3be8c^"
	test -f /sys/class/thermal/thermal_zone0/temp || return 0
    printf "%sT %sÂ°C" $color $(head -c 2 /sys/class/thermal/thermal_zone0/temp)
}

print_bat(){
    color="^c#eceff4^"
    for battery in /sys/class/power_supply/BAT?*; do
	    [ -n "${capacity+x}" ] && printf " "
	    case "$(cat "$battery/status" 2>&1)" in
	    	"Full") status="" ;;
	    	"Discharging") isDischarging="yes" ;;
	    	"Charging") status="plug " ;;
	    	"Not charging") status="X" ;;
	    	"Unknown") status="~" ;;
	    	*) exit 1 ;;
	    esac
	    capacity="$(cat "$battery/capacity" 2>&1)"
	    [ "$isDischarging" = "yes" ] && [ "$capacity" -le 18 ] && unset isDischarging && dunstify -h string:x-dunst-stack-tag:low-battery -u CRITICAL "Help" "Low battery!"
        printf "%sB %s%s%% " $color $status $capacity
    done
}

print_date(){
    dateColor="^c#8fbcbb^"
    separatorColor="^c#bf616a^"
    timeColor="^c#b48ead^"
    printf "%s%s %s> %s%s" "$dateColor" "$(date '+%A %d %B')" "$separatorColor" "$timeColor" "$(date '+%H:%M')"
}

print_volume(){
    color="^c#5e81ac^"
    volstat="$(pactl list sinks)"
    echo "$volstat" | grep -q "Mute: yes" && printf "%sMuted\\n" $color && exit
    vol="$(echo "$volstat" | grep '[0-9]\+%' | sed "s,.* \([0-9]\+\)%.*,\1,;1q")"
    printf "%sV %s%%" $color "$vol"
}

while true
do
    xsetroot -name "$(print_network) $(print_volume) $(print_mem) $(print_cpu) $(print_temp) $(print_bat)$(print_date) "
	sleep 3
done
