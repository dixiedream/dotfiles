#!/bin/bash
# Network speed stuff stolen from http://linuxclues.blogspot.sg/2009/11/shell-script-show-network-speed.html

print_mem(){
    # free -m | awk 'NR==2{printf "%s%sM\n", "^c#EBCB8B^", $3 }'
    free -m | awk 'NR==2{printf "%sM\n", $3 }'
}

print_cpu(){
    cpu="$(top -b -n1 | grep "Cpu(s)" | awk '{print $2 + $4}' | sed "s/\..*//")"
    printf "CPU %s%%" $color $cpu
}

print_network(){
	logfile=/dev/shm/netlog
	[ -f "$logfile" ] || echo "0 0" > "$logfile"
	read -r rxprev txprev < "$logfile"
	rxcurrent="$(($(paste -d '+' /sys/class/net/[ew]*/statistics/rx_bytes)))"
	txcurrent="$(($(paste -d '+' /sys/class/net/[ew]*/statistics/tx_bytes)))"
	printf "D %s U %s" $(bc <<< "scale=2; ($rxcurrent-$rxprev) / 10^6") $(bc <<< "scale=2; ($txcurrent-$txprev) / 10^6")
	echo "$rxcurrent $txcurrent" > "$logfile"
}

print_temp(){
	test -f /sys/class/thermal/thermal_zone0/temp || return 0
  printf "T %sÂ°C" $(head -c 2 /sys/class/thermal/thermal_zone0/temp)
}

print_bat(){
    maxCapacity=0
    for battery in /sys/class/power_supply/BAT?*; do
	    case "$(cat "$battery/status" 2>&1)" in
	    	"Full") status="" ;;
	    	"Discharging") isDischarging="yes" && status="" ;;
	    	"Charging") status="plug " ;;
	    	"Not charging") status="X" ;;
	    	"Unknown") status="~" ;;
	    	*) exit 1 ;;
	    esac
	    capacity="$(cat "$battery/capacity" 2>&1)"
      [ "$maxCapacity" -le "$capacity" ] && maxCapacity=$capacity
	    [ "$isDischarging" = "yes" ] && [ "$maxCapacity" -le 18 ] && unset isDischarging && dunstify -h string:x-dunst-stack-tag:low-battery -u CRITICAL "Help" "Low battery!"
      printf "B %s%s%% " $status $capacity
    done
}

print_date(){
    printf "%s > %s" "$(date '+%A %d %B')" "$(date '+%H:%M')"
}

print_volume(){
    volstat="$(wpctl get-volume @DEFAULT_AUDIO_SINK@)"
    echo "$volstat" | grep -q "MUTED" && printf "Muted\\n" && exit
    vol="$(wpctl get-volume @DEFAULT_AUDIO_SINK@ | grep '[0-9]' | awk '{ print $2*100 }')"
    printf "V %s%%" "$vol"
}

while true
do
  xsetroot -name "$(print_network) $(print_volume) $(print_mem) $(print_cpu) $(print_temp) $(print_bat)$(print_date) "
	sleep 5
done
