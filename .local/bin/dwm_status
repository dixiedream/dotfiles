#!/bin/sh
# Network speed stuff stolen from http://linuxclues.blogspot.sg/2009/11/shell-script-show-network-speed.html

print_mem(){
    free -m | awk 'NR==2{printf "%sMb\n", $3 }'
}

net_update() {
    sum=0
    for arg; do
        read -r i < "$arg"
        sum=$(( sum + i ))
    done
    cache=${XDG_CACHE_HOME:-$HOME/.cache}/${1##*/}
    [ -f "$cache" ] && read -r old < "$cache" || old=0
    printf %d\\n "$sum" > "$cache"
    printf %d\\n $(( sum - old ))
}

print_network(){
    rx=$(net_update /sys/class/net/[ew]*/statistics/rx_bytes)
    tx=$(net_update /sys/class/net/[ew]*/statistics/tx_bytes)
    printf "D%4sB U%4sB\\n" $(numfmt --to=iec $rx) $(numfmt --to=iec $tx)
}

print_cpu(){
    cpu="$(top -b -n1 | grep "Cpu(s)" | awk '{print $2 + $4}' | sed "s/\..*//")"
    printf %s "$cpu%"
}

print_temp(){
	test -f /sys/class/thermal/thermal_zone0/temp || return 0
    printf "%sÂ°C" "$(head -c 2 /sys/class/thermal/thermal_zone0/temp)"
}

print_bat(){
    battery="BAT0"
    capacity="$(cat /sys/class/power_supply/$battery/capacity)%"
    status=$(sed "s/[Dd]ischarging//;s/[Nn]ot charging//;s/[Cc]harging/plug /;s/[Uu]nknown/?/;s/[Ff]ull//" /sys/class/power_supply/$battery/status)
    printf "%s%s" "$status" "$capacity"
}

print_date(){
    printf '%s - %s%s ' "$(date '+%b %d')" "$(date '+%H:%M')"    
}

print_volume(){
    volstat="$(pactl list sinks)"
    echo "$volstat" | grep -q "Mute: yes" && printf "Muted\\n" && exit
    vol="$(echo "$volstat" | grep '[0-9]\+%' | sed "s,.* \([0-9]\+\)%.*,\1,;1q")"
    printf "V %s%%" "$vol"
}

while true
do
    xsetroot -name "M $(print_mem) | $(print_network) | CPU $(print_cpu) $(print_temp) | B $(print_bat) | $(print_volume) | $(print_date)"
	sleep 1
done
